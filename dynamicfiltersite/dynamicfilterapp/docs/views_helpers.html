<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>views_helpers.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>views_helpers.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Task</span><span class="p">,</span> <span class="n">RestaurantPredicate</span><span class="p">,</span> <span class="n">Restaurant</span><span class="p">,</span> <span class="n">PredicateBranch</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">btdtr</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span><span class="p">,</span> <span class="n">choice</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">exp</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>we need at least half of the answers to be True in order for the value of the predicate to be True
and same for False's</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">DECISION_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.5</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>the uncertainty level determined by the beta distribution function needs to be less than 0.15
for us to fix the predicate's value</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">UNCERTAINTY_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.15</span>

<span class="n">ALPHA</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">GAMMA</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="n">INDEX</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">MEMORY_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Checks if predicate needs to be answered 0 more times. If uncertainty criteria are met,
combines worker responses into one value for the predicate. Otherwise, adds five to the 
appropriate predicateStatus so that more answers will be collected.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">aggregate_responses</span><span class="p">(</span><span class="n">predicate</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>retrieves the number of yes answers and number of no answers for the 
predicate relative to the answers' confidence levels</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">yes</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">restaurantPredicate</span><span class="o">=</span><span class="n">predicate</span><span class="p">,</span> <span class="n">answer</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">no</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">restaurantPredicate</span><span class="o">=</span><span class="n">predicate</span><span class="p">,</span> <span class="n">answer</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>initialize the number of yes's and no's to 0</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">totalYes</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">totalNo</span> <span class="o">=</span> <span class="mf">0.0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>for all predicates answered yes</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">yes</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>increase total number of yes by the confidence level indicated</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">totalYes</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">confidenceLevel</span><span class="o">/</span><span class="mf">100.0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>increase total number of no by 100 - confidence level indicated</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">totalNo</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pred</span><span class="o">.</span><span class="n">confidenceLevel</span><span class="o">/</span><span class="mf">100.0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>for all predicates answered no</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">no</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>increase total number of no by 100 - the confidence level 
indicated</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">totalYes</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pred</span><span class="o">.</span><span class="n">confidenceLevel</span><span class="o">/</span><span class="mf">100.0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>increase total number of no by confidence level indicated</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">totalNo</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">confidenceLevel</span><span class="o">/</span><span class="mf">100.0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>How we compute the uncertaintly level changes depending on whether the answer is True or False</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">uncertaintyLevelTrue</span> <span class="o">=</span> <span class="n">btdtr</span><span class="p">(</span><span class="n">totalYes</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">totalNo</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">DECISION_THRESHOLD</span><span class="p">)</span>
    <span class="n">uncertaintyLevelFalse</span> <span class="o">=</span> <span class="n">btdtr</span><span class="p">(</span><span class="n">totalNo</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">totalYes</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">DECISION_THRESHOLD</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>if more yes's than no's</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">totalYes</span> <span class="o">&gt;</span> <span class="n">totalNo</span> <span class="ow">and</span> <span class="n">uncertaintyLevelTrue</span> <span class="o">&lt;</span> <span class="n">UNCERTAINTY_THRESHOLD</span><span class="p">:</span>
        <span class="n">predicate</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>if more no's than yes's</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">elif</span> <span class="n">totalNo</span> <span class="o">&gt;</span> <span class="n">totalYes</span> <span class="ow">and</span> <span class="n">uncertaintyLevelFalse</span> <span class="o">&lt;</span> <span class="n">UNCERTAINTY_THRESHOLD</span><span class="p">:</span>
        <span class="n">predicate</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>flag for the Restaurant failing a predicate (and thus not passing all the predicates)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">predicateFailed</span> <span class="o">=</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>iterates through all the fields in this restaurant's model</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">predicate</span><span class="o">.</span><span class="n">restaurant</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>verbose_name is the field's name with underscores replaced with spaces</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">verbose_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;predicate&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">verbose_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;Status&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">predicate</span><span class="o">.</span><span class="n">restaurant</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">verbose_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">predicateFailed</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">predicateFailed</span><span class="p">:</span>
            <span class="n">predicate</span><span class="o">.</span><span class="n">restaurant</span> <span class="o">=</span> <span class="n">markFailed</span><span class="p">(</span><span class="n">predicate</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">predicate</span><span class="o">.</span><span class="n">value</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>collect five more responses from workers when there are same 
number of yes and no</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">predicate</span><span class="o">.</span><span class="n">restaurant</span> <span class="o">=</span> <span class="n">incrementStatus</span><span class="p">(</span><span class="n">predicate</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">predicate</span><span class="o">.</span><span class="n">restaurant</span><span class="p">)</span>
    <span class="n">predicate</span><span class="o">.</span><span class="n">restaurant</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">predicate</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>printResults()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">predicate</span><span class="o">.</span><span class="n">restaurant</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>If there are no more predicates to be evaluated, print the restaurants satisfying all
predicates to the terminal.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">printResults</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">left</span> <span class="o">=</span> <span class="n">RestaurantPredicate</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;----------RESULTS-----------&quot;</span>
        <span class="k">print</span> <span class="s">&quot;The following restaurants satisfied all predicates&quot;</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">Restaurant</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">hasFailed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">restaurant</span> <span class="ow">in</span> <span class="n">filtered</span><span class="p">:</span>
            <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">restaurant</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">restaurant</span><span class="o">.</span><span class="n">predicate0Status</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">restaurant</span><span class="o">.</span><span class="n">predicate1Status</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">restaurant</span><span class="o">.</span><span class="n">predicate2Status</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="s">&quot;----------------------------&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Set all predicate status fields to -1 to indicate that it needs no further evaluation (because
it has failed a predicate)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">markFailed</span><span class="p">(</span><span class="n">predicate</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">predicate</span><span class="o">.</span><span class="n">restaurant</span><span class="o">.</span><span class="n">hasFailed</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">predicate</span><span class="o">.</span><span class="n">restaurant</span><span class="o">.</span><span class="n">queueIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">predicate</span><span class="o">.</span><span class="n">restaurant</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>updates the predicate branch's total and "No!" counts relative to the confidence levels</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">updateCounts</span><span class="p">(</span><span class="n">pB</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">answer</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
        <span class="n">pB</span><span class="o">.</span><span class="n">returnedTotal</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">confidenceLevel</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span>
    <span class="k">elif</span> <span class="n">task</span><span class="o">.</span><span class="n">answer</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
        <span class="n">pB</span><span class="o">.</span><span class="n">returnedTotal</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">confidenceLevel</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span>
        <span class="n">pB</span><span class="o">.</span><span class="n">returnedNo</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">confidenceLevel</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>print "PB counts updated to: total: " + str(pB.returnedTotal) + " and no: " + str(pB.returnedNo) </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">pB</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>def findNumPredicates():
    # all fields for a restaurant referenced by an incomplete predicate
    restaurantFields = RestaurantPredicate.objects.all()[0].restaurant._meta.fields</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <pre><code># finds number of predicate statuses
numOfPredicateStatuses = 0
for field in restaurantFields:
    if field.verbose_name.startswith('predicate') and field.verbose_name.endswith('Status'):
        numOfPredicateStatuses += 1
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <pre><code>return numOfPredicateStatuses
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>Uses a random lottery system to determine which eligible predicate should be
evaluated next.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">eddy</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">numOfPredicates</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>find all the tasks this worker has completed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">completedTasks</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">workerID</span><span class="o">=</span><span class="n">ID</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>find all the predicates matching these completed tasks</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">completedPredicates</span> <span class="o">=</span> <span class="n">RestaurantPredicate</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">id__in</span><span class="o">=</span><span class="n">completedTasks</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;restaurantPredicate_id&#39;</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>excludes all completed predicates from all restaurant predicates to get only incompleted ones</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">incompletePredicates1</span> <span class="o">=</span> <span class="n">RestaurantPredicate</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">completedPredicates</span><span class="p">)</span>

    <span class="n">incompletePredicates</span> <span class="o">=</span> <span class="n">incompletePredicates1</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">restaurant__hasFailed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <h1>print "incompletePredicates: "</h1>
<p>for ip in incompletePredicates:
    print ip
finds eligible predicate branches</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">eligiblePredicateBranches</span> <span class="o">=</span> <span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>print "numOfPredicates: " + str(numOfPredicates)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numOfPredicates</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">incompletePredicates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">index</span><span class="o">==</span><span class="n">i</span><span class="p">:</span>
                <span class="n">eligiblePredicateBranches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PredicateBranch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">break</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>print "Eligible predicate branches: " + str(eligiblePredicateBranches)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eligiblePredicateBranches</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">chosenBranch</span> <span class="o">=</span> <span class="n">runLotteryWeighted</span><span class="p">(</span><span class="n">eligiblePredicateBranches</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>generates the restaurant with the highest priority for the specified 
predicate branch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">chosenRestaurant</span> <span class="o">=</span> <span class="n">findRestaurant</span><span class="p">(</span><span class="n">chosenBranch</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>mark chosenRestaurant as being in chosenBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">chosenRestaurant</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">chosenBranch</span><span class="o">.</span><span class="n">index</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>Find the RestaurantPredicate corresponding to this Restaurant and 
PredicateBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">chosenPredicate</span> <span class="o">=</span> <span class="n">RestaurantPredicate</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">restaurant</span> <span class="o">=</span> <span class="n">chosenRestaurant</span><span class="p">,</span> <span class="n">question</span> <span class="o">=</span> <span class="n">chosenBranch</span><span class="o">.</span><span class="n">question</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">chosenPredicate</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>Picks a  Restaurant, then uses a lottery system to determine the next PredicateBranch to send the Restaurant to. 
If the Restaurant is likely to be False for one particular PredicateBranch, it may be "fast-tracked" to that PB rather
than choosing via the lottery.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">eddy2</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">numOfPredicates</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>find the first Restaurant in the queue that isn't finished</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">sortedRestaurants</span> <span class="o">=</span> <span class="n">Restaurant</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">queueIndex</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;queueIndex&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>return if there are no unfinished Restaurants, otherwise take the first one in the queue</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sortedRestaurants</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="n">sortedRestaurants</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>find all the Tasks this worker has completed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">completedTasks</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">workerID</span><span class="o">=</span><span class="n">ID</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>find all the RestaurantPredicates matching these completed Tasks</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">completedPredicates</span> <span class="o">=</span> <span class="n">RestaurantPredicate</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">id__in</span><span class="o">=</span><span class="n">completedTasks</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;restaurantPredicate_id&#39;</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>get only incomplete RestaurantPredicates matching this Restaurant and eligible to this worker</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">incompletePredicates</span> <span class="o">=</span> <span class="n">RestaurantPredicate</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">completedPredicates</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">restaurant__hasFailed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">restaurant</span><span class="o">=</span><span class="n">rest</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>check for RestaurantPredicates that are likely to evaluate to False (meeting the specified uncertainty threshold)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">almostFalsePredicates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">FALSE_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.30</span> <span class="c"># was 0.15</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>finds all the predicates that are almost False, less than 30% uncertain</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">incompletePredicates</span><span class="p">:</span>
        <span class="n">numYes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">restaurantPredicate</span><span class="o">=</span><span class="n">pred</span><span class="p">,</span> <span class="n">answer</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">numNo</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">restaurantPredicate</span><span class="o">=</span><span class="n">pred</span><span class="p">,</span> <span class="n">answer</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">btdtr</span><span class="p">(</span><span class="n">numNo</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">numYes</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.50</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">uncertainty</span> <span class="o">&lt;</span> <span class="n">FALSE_THRESHOLD</span><span class="p">:</span>
            <span class="n">almostFalsePredicates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">uncertainty</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">almostFalsePredicates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>sort according to uncertainty, ascendingly, and return the predicate
which is the second item of the first tuple</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">almostFalsePredicates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">almostFalsePredicates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>If we've failed to find a predicate to prioritize, run the lottery on all eligible PBs
finds eligible predicate branches</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">eligiblePredicateBranches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numOfPredicates</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">incompletePredicates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">eligiblePredicateBranches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">PredicateBranch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">break</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>finds predicate branch using weighted lottery</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eligiblePredicateBranches</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">chosenBranch</span> <span class="o">=</span> <span class="n">runLotteryWeighted</span><span class="p">(</span><span class="n">eligiblePredicateBranches</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>Find the RestaurantPredicate corresponding to this Restaurant and 
PredicateBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">chosenPredicate</span> <span class="o">=</span> <span class="n">RestaurantPredicate</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">restaurant</span><span class="o">=</span><span class="n">rest</span><span class="p">,</span> <span class="n">question</span><span class="o">=</span><span class="n">chosenBranch</span><span class="o">.</span><span class="n">question</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">chosenPredicate</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>decrease the status by 1 once an answer has been submitted for that predicate</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">decrementStatus</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">restaurant</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">check</span> <span class="o">=</span> <span class="s">&#39;predicate&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>iterates through all the fields in restaurant</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">restaurant</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">verbose_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">check</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">verbose_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;Status&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>gets the number times the predicate still needs to be asked to this restaurant</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">currentLeftToAsk</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">restaurant</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">verbose_name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p>sets the field to currentLeftToAsk-1</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="nb">setattr</span><span class="p">(</span><span class="n">restaurant</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">verbose_name</span><span class="p">,</span> <span class="n">currentLeftToAsk</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">restaurant</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>Increases the number of responses needed for an item-predicate pair by 2.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">incrementStatus</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">restaurant</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">statusName</span> <span class="o">=</span> <span class="s">&#39;predicate&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;Status&#39;</span>

    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">restaurant</span><span class="p">,</span> <span class="n">statusName</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">restaurant</span><span class="p">,</span> <span class="n">statusName</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">restaurant</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">restaurant</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <p>Find the total number of "tickets" held by a set of PredicateBranches, multiplying their
selectivities by 1000 and casting them to integers.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">findTotalTickets</span><span class="p">(</span><span class="n">pbSet</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">totalTickets</span> <span class="o">=</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <p>award tickets based on computed selectivity</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="n">pbSet</span><span class="p">:</span>
        <span class="n">selectivity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">returnedTotal</span><span class="p">)</span>
        <span class="n">totalTickets</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">selectivity</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">totalTickets</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>Runs a ticket-based lottery to choose a PredicateBranch.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">runLottery</span><span class="p">(</span><span class="n">pbSet</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>retrieves total num of tickets in valid predicates branches</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">totalTickets</span> <span class="o">=</span> <span class="n">findTotalTickets</span><span class="p">(</span><span class="n">pbSet</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">totalTickets</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      <p>generate random number between 1 and totalTickets</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">rand</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">totalTickets</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      <p>check if rand falls in the range corresponding to each predicate</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">lowBound</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">selectivity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pbSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">)</span><span class="o">/</span><span class="n">pbSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">returnedTotal</span>
    <span class="n">highBound</span> <span class="o">=</span> <span class="n">selectivity</span><span class="o">*</span><span class="mi">1000</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>an empty PredicateBranch object NOT saved in the database</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">chosenBranch</span> <span class="o">=</span> <span class="n">PredicateBranch</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      <p>loops through all valid predicate branches</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pbSet</span><span class="p">)):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p>if rand is in this range, then go to this predicateBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">lowBound</span> <span class="o">&lt;=</span> <span class="n">rand</span> <span class="o">&lt;=</span> <span class="n">highBound</span><span class="p">:</span>
            <span class="n">chosenBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      <p>move on to next range of predicateBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">lowBound</span> <span class="o">=</span> <span class="n">highBound</span>
            <span class="n">nextPredicateBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nextSelectivity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nextPredicateBranch</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">)</span><span class="o">/</span><span class="n">nextPredicateBranch</span><span class="o">.</span><span class="n">returnedTotal</span>
            <span class="n">highBound</span> <span class="o">+=</span> <span class="n">nextSelectivity</span><span class="o">*</span><span class="mi">1000</span>

    <span class="k">return</span> <span class="n">chosenBranch</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      <p>Runs a ticket-based lottery to choose a PredicateBranch. Doubles the tickets of the most selective
PredicateBranch in order to favor it more strongly.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">runLotteryWeighted</span><span class="p">(</span><span class="n">pbSet</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">totalTickets</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tickets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">highestBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      <p>assigns tickets to each branch and finds the most selective one</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">pbSet</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">branch</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">)</span><span class="o">/</span><span class="n">branch</span><span class="o">.</span><span class="n">returnedTotal</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span>
        <span class="n">tickets</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">totalTickets</span> <span class="o">+=</span> <span class="n">t</span>

        <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">highestBranch</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">)</span><span class="o">/</span><span class="n">highestBranch</span><span class="o">.</span><span class="n">returnedTotal</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">:</span>
            <span class="n">highestBranch</span> <span class="o">=</span> <span class="n">branch</span>
            <span class="n">highestSelectivity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">highestBranch</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">)</span><span class="o">/</span><span class="n">highestBranch</span><span class="o">.</span><span class="n">returnedTotal</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      <p>favors most selective branch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">weightingFactor</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">tickets</span><span class="p">[</span><span class="n">highestBranch</span><span class="p">]</span> <span class="o">*=</span> <span class="n">weightingFactor</span>
    <span class="n">totalTickets</span> <span class="o">+=</span> <span class="n">tickets</span><span class="p">[</span><span class="n">highestBranch</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weightingFactor</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">weightingFactor</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-74'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-74'>#</a>
      </div>
      <p>generate random number between 1 and totalTickets</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">rand</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">totalTickets</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-75'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-75'>#</a>
      </div>
      <p>check if rand falls in the range corresponding to each predicate</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    
    <span class="n">lowBound</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">highBound</span> <span class="o">=</span> <span class="n">tickets</span><span class="p">[</span><span class="n">pbSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-76'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-76'>#</a>
      </div>
      <p>an empty PredicateBranch object NOT saved in the database</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">chosenBranch</span> <span class="o">=</span> <span class="n">PredicateBranch</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-77'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-77'>#</a>
      </div>
      <p>loops through all valid predicate branches</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pbSet</span><span class="p">)):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-78'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-78'>#</a>
      </div>
      <p>if rand is in this range, then go to this predicateBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">lowBound</span> <span class="o">&lt;=</span> <span class="n">rand</span> <span class="o">&lt;=</span> <span class="n">highBound</span><span class="p">:</span>
            <span class="n">chosenBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-79'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-79'>#</a>
      </div>
      <p>move on to next range of predicateBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">lowBound</span> <span class="o">=</span> <span class="n">highBound</span>
            <span class="n">nextPredicateBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">highBound</span> <span class="o">+=</span> <span class="n">tickets</span><span class="p">[</span><span class="n">nextPredicateBranch</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">chosenBranch</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-80'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-80'>#</a>
      </div>
      <p>Runs a ticket-based lottery to choose a PredicateBranch. Doubles the tickets of the most selective
PredicateBranch in order to favor it more strongly. Remembers which PredicateBranch had the highest selectivity
in the last run of the lottery, and requires that another PredicateBranch have a selectivity that is higher by a certain 
threshold in order to become the new favored PredicateBranch. This is done so that the choice of which PredicateBranch is
weighted (favored) changes less often.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">runLotteryWeightedWithMemory</span><span class="p">(</span><span class="n">pbSet</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-81'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-81'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">global</span> <span class="n">INDEX</span>

    <span class="n">changeBranch</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">pastBranchExists</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">totalTickets</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tickets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">highestBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">highestSelectivity</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">otherSelectivities</span> <span class="o">=</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-82'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-82'>#</a>
      </div>
      <p>checks if highest predicate branch from last time still exists in pbSet</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="n">pbSet</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pb</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">INDEX</span><span class="p">:</span>
            <span class="n">pastBranchExists</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">predBranch</span> <span class="o">=</span> <span class="n">pb</span>
            <span class="k">break</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-83'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-83'>#</a>
      </div>
      <p>assigns tickets to each predicate branch and finds branch with highest selectivity</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">pbSet</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-84'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-84'>#</a>
      </div>
      <p>print branch.question</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">branch</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">)</span><span class="o">/</span><span class="n">branch</span><span class="o">.</span><span class="n">returnedTotal</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span>
        <span class="n">tickets</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">totalTickets</span> <span class="o">+=</span> <span class="n">t</span>

        <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">highestBranch</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">)</span><span class="o">/</span><span class="n">highestBranch</span><span class="o">.</span><span class="n">returnedTotal</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">:</span>
            <span class="n">highestBranch</span> <span class="o">=</span> <span class="n">branch</span>
            <span class="n">highestSelectivity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">highestBranch</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">)</span><span class="o">/</span><span class="n">highestBranch</span><span class="o">.</span><span class="n">returnedTotal</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-85'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-85'>#</a>
      </div>
      <p>an empty PredicateBranch object NOT saved in the database</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">chosenBranch</span> <span class="o">=</span> <span class="n">PredicateBranch</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-86'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-86'>#</a>
      </div>
      <p>if the branch picked before still exists, check if new branch surpasses threshold</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">pastBranchExists</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">highestBranch</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">highestBranch</span><span class="o">.</span><span class="n">returnedTotal</span><span class="p">)</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">predBranch</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">predBranch</span><span class="o">.</span><span class="n">returnedTotal</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MEMORY_THRESHOLD</span><span class="p">:</span> 
            <span class="n">changeBranch</span> <span class="o">=</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-87'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-87'>#</a>
      </div>
      <p>favors the most selective one if it surpasses the threshold</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">weightingFactor</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">changeBranch</span><span class="p">:</span>
        <span class="n">tickets</span><span class="p">[</span><span class="n">highestBranch</span><span class="p">]</span> <span class="o">*=</span> <span class="n">weightingFactor</span>
        <span class="n">totalTickets</span> <span class="o">+=</span> <span class="n">tickets</span><span class="p">[</span><span class="n">highestBranch</span><span class="p">]</span><span class="o">/</span><span class="n">weightingFactor</span><span class="o">*</span><span class="p">(</span><span class="n">weightingFactor</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tickets</span><span class="p">[</span><span class="n">predBranch</span><span class="p">]</span> <span class="o">*=</span> <span class="n">weightingFactor</span>
        <span class="n">totalTickets</span> <span class="o">+=</span> <span class="n">tickets</span><span class="p">[</span><span class="n">predBranch</span><span class="p">]</span><span class="o">/</span><span class="n">weightingFactor</span><span class="o">*</span><span class="p">(</span><span class="n">weightingFactor</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-88'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-88'>#</a>
      </div>
      <p>generate random number between 1 and totalTickets</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">rand</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">totalTickets</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-89'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-89'>#</a>
      </div>
      <p>check if rand falls in the range corresponding to each predicate</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    
    <span class="n">lowBound</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">highBound</span> <span class="o">=</span> <span class="n">tickets</span><span class="p">[</span><span class="n">pbSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-90'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-90'>#</a>
      </div>
      <p>an empty PredicateBranch object NOT saved in the database</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">chosenBranch</span> <span class="o">=</span> <span class="n">PredicateBranch</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-91'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-91'>#</a>
      </div>
      <p>loops through all valid predicate branches</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pbSet</span><span class="p">)):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-92'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-92'>#</a>
      </div>
      <p>if rand is in this range, then go to this predicateBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">lowBound</span> <span class="o">&lt;=</span> <span class="n">rand</span> <span class="o">&lt;=</span> <span class="n">highBound</span><span class="p">:</span>
            <span class="n">chosenBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-93'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-93'>#</a>
      </div>
      <p>move on to next range of predicateBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">lowBound</span> <span class="o">=</span> <span class="n">highBound</span>
            <span class="n">nextPredicateBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">highBound</span> <span class="o">+=</span> <span class="n">tickets</span><span class="p">[</span><span class="n">nextPredicateBranch</span><span class="p">]</span>

    <span class="n">INDEX</span> <span class="o">=</span> <span class="n">chosenBranch</span><span class="o">.</span><span class="n">index</span>

    <span class="k">return</span> <span class="n">chosenBranch</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-94'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-94'>#</a>
      </div>
      <p>Runs a ticket-based lottery to choose a PredicateBranch. Increases the tickets of the most selective
PredicateBranch in order to favor it more strongly. The weighting factor increases with the number of
tasks done, up to a maximum of 2. (This lottery is kept for possible future exploration but not currently
in use.)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">runLotteryDynamicallyWeighted</span><span class="p">(</span><span class="n">pbSet</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-95'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-95'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">totalTickets</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tickets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">highestBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">pbSet</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">branch</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">)</span><span class="o">/</span><span class="n">branch</span><span class="o">.</span><span class="n">returnedTotal</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span>
        <span class="n">tickets</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">totalTickets</span> <span class="o">+=</span> <span class="n">t</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">highestBranch</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">)</span><span class="o">/</span><span class="n">highestBranch</span><span class="o">.</span><span class="n">returnedTotal</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">:</span>
            <span class="n">highestBranch</span> <span class="o">=</span> <span class="n">branch</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">tickets</span><span class="p">[</span><span class="n">highestBranch</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span><span class="o">/</span><span class="mi">25</span><span class="o">*.</span><span class="mi">25</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tickets</span><span class="p">[</span><span class="n">highestBranch</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-96'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-96'>#</a>
      </div>
      <p>generate random number between 1 and totalTickets</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">rand</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">totalTickets</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-97'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-97'>#</a>
      </div>
      <p>check if rand falls in the range corresponding to each predicate</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">lowBound</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">highBound</span> <span class="o">=</span> <span class="n">tickets</span><span class="p">[</span><span class="n">pbSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-98'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-98'>#</a>
      </div>
      <p>an empty PredicateBranch object NOT saved in the database</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">chosenBranch</span> <span class="o">=</span> <span class="n">PredicateBranch</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-99'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-99'>#</a>
      </div>
      <p>loops through all valid predicate branches</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pbSet</span><span class="p">)):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-100'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-100'>#</a>
      </div>
      <p>if rand is in this range, then go to this predicateBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">lowBound</span> <span class="o">&lt;=</span> <span class="n">rand</span> <span class="o">&lt;=</span> <span class="n">highBound</span><span class="p">:</span>
            <span class="n">chosenBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-101'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-101'>#</a>
      </div>
      <p>move on to next range of predicateBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">lowBound</span> <span class="o">=</span> <span class="n">highBound</span>
            <span class="n">nextPredicateBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">highBound</span> <span class="o">+=</span> <span class="n">tickets</span><span class="p">[</span><span class="n">nextPredicateBranch</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">chosenBranch</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-102'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-102'>#</a>
      </div>
      <p>Runs a ticket-based lottery to choose a PredicateBranch. Averages the selectivity distribution with a uniform distribution
to favor "exploration" of different PredicateBranches more strongly. (This lottery is kept for possible future exploration but not currently
in use.)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">runLotteryWithUniform</span><span class="p">(</span><span class="n">pbSet</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-103'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-103'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">totalTickets</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">rangeRand</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">tickets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">highestBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">pbSet</span><span class="p">:</span>
        <span class="n">totalTickets</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">ALPHA</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">branch</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">pbSet</span><span class="p">:</span>
        <span class="n">tickets</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">ALPHA</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">branch</span><span class="o">.</span><span class="n">returnedNo</span><span class="p">))</span><span class="o">/</span><span class="n">totalTickets</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">GAMMA</span><span class="p">)</span> <span class="o">+</span> <span class="n">GAMMA</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">PredicateBranch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">rangeRand</span><span class="o">+=</span> <span class="n">tickets</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-104'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-104'>#</a>
      </div>
      <p>generate random number between 1 and totalTickets</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">rand</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">rangeRand</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-105'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-105'>#</a>
      </div>
      <p>check if rand falls in the range corresponding to each predicate</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    
    <span class="n">lowBound</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">highBound</span> <span class="o">=</span> <span class="n">tickets</span><span class="p">[</span><span class="n">pbSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-106'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-106'>#</a>
      </div>
      <p>an empty PredicateBranch object NOT saved in the database</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">chosenBranch</span> <span class="o">=</span> <span class="n">PredicateBranch</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-107'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-107'>#</a>
      </div>
      <p>loops through all valid predicate branches</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pbSet</span><span class="p">)):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-108'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-108'>#</a>
      </div>
      <p>if rand is in this range, then go to this predicateBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">lowBound</span> <span class="o">&lt;=</span> <span class="n">rand</span> <span class="o">&lt;=</span> <span class="n">highBound</span><span class="p">:</span>
            <span class="n">chosenBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-109'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-109'>#</a>
      </div>
      <p>move on to next range of predicateBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">lowBound</span> <span class="o">=</span> <span class="n">highBound</span>
            <span class="n">nextPredicateBranch</span> <span class="o">=</span> <span class="n">pbSet</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">highBound</span> <span class="o">+=</span> <span class="n">tickets</span><span class="p">[</span><span class="n">nextPredicateBranch</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">chosenBranch</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-110'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-110'>#</a>
      </div>
      <p>Finds the restaurant with the highest priority for a specified predicate such that the relevant worker
has not answered the relevant question about the restaurant.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">findRestaurant</span><span class="p">(</span><span class="n">predicateBranch</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-111'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-111'>#</a>
      </div>
      <p>find all the tasks this worker has completed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">completedTasks</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">workerID</span><span class="o">=</span><span class="n">ID</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-112'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-112'>#</a>
      </div>
      <p>find all the predicates for this branch that have been done by the worker</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">completedPredicates</span> <span class="o">=</span> <span class="n">RestaurantPredicate</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="n">predicateBranch</span><span class="o">.</span><span class="n">question</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">id__in</span><span class="o">=</span><span class="n">completedTasks</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;restaurantPredicate_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-113'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-113'>#</a>
      </div>
      <p>get the Restaurants NOT associated with the completed predicates</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">rSet</span> <span class="o">=</span> <span class="n">Restaurant</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">completedPredicates</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;restaurant_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">hasFailed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-114'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-114'>#</a>
      </div>
      <p>order the eligible restaurants by priority</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">orderByThisStatus</span> <span class="o">=</span> <span class="s">&#39;-predicate&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">predicateBranch</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;Status&#39;</span>
    <span class="n">prioritized</span> <span class="o">=</span> <span class="n">rSet</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">orderByThisStatus</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prioritized</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-115'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-115'>#</a>
      </div>
      <p>def findRestaurant(predicateBranch,ID):
    """
    Finds a random eligible restaurant.
    """
    # find all the tasks this worker has completed
    completedTasks = Task.objects.filter(workerID=ID)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-116'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-116'>#</a>
      </div>
      <pre><code># find all the predicates for this branch that have been done by the worker
completedPredicates = RestaurantPredicate.objects.filter(question=predicateBranch.question).filter(
    id__in=completedTasks.values('restaurantPredicate_id')).filter(value=None)
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-117'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-117'>#</a>
      </div>
      <pre><code># get the Restaurants NOT associated with the completed predicates
rSet = Restaurant.objects.exclude(id__in=completedPredicates.values('restaurant_id')).exclude(hasFailed=True).order_by('?')
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-118'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-118'>#</a>
      </div>
      <pre><code>return rSet[0]
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-119'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-119'>#</a>
      </div>
      <p>------------------------------------------------------------------------------------------------------------------------------------#</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-120'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-120'>#</a>
      </div>
      <pre><code>if status &gt; 0:
    lowestStat = status
    break
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-121'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-121'>#</a>
      </div>
      <p>lowestUncertainty = 1.0
predicate = RestaurantPredicate.objects.filter(question=predicateBranch.question)[0]
for restaurant in prioritized:
    status = getattr(restaurant, predStatus)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-122'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-122'>#</a>
      </div>
      <pre><code>if status &gt; lowestStat:
    break
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-123'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-123'>#</a>
      </div>
      <pre><code>if status == lowestStat:
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-124'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-124'>#</a>
      </div>
      <pre><code>    yes = Task.objects.filter(restaurantPredicate=predicate, answer = True)
    no = Task.objects.filter(restaurantPredicate=predicate, answer = False)
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-125'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-125'>#</a>
      </div>
      <pre><code>    totalYes = 0.0
    totalNo = 0.0
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-126'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-126'>#</a>
      </div>
      <pre><code>    for pred in yes:
        totalYes += pred.confidenceLevel/100.0
        totalNo += 1 - pred.confidenceLevel/100.0
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-127'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-127'>#</a>
      </div>
      <pre><code>    for pred in no:
        totalYes += 1 - pred.confidenceLevel/100.0
        totalNo += pred.confidenceLevel/100.0
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-128'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-128'>#</a>
      </div>
      <pre><code>    uncertaintyLevelFalse = btdtr(totalNo+1, totalYes+1, DECISION_THRESHOLD)
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-129'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-129'>#</a>
      </div>
      <pre><code>    if uncertaintyLevelFalse &lt; lowestUncertainty:
        chosenRestaurant = restaurant
        lowestUncertainty = uncertaintyLevelFalse
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-130'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-130'>#</a>
      </div>
      <p>return chosenRestaurant</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-131'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-131'>#</a>
      </div>
      <p>--------------------------------------------------------------------------------------------------------------------------------------#</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-132'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-132'>#</a>
      </div>
      <p>Randomly selects the next predicate from the available choices. Does not use lottery or queue.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">randomAlgorithm</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">numOfPredicates</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-133'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-133'>#</a>
      </div>
      <p>get all the tasks this worker has done</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">completedTasks</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">workerID</span><span class="o">=</span><span class="n">ID</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-134'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-134'>#</a>
      </div>
      <p>find all the predicates that haven't been done by this worker</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">notCompletedPredicates</span> <span class="o">=</span> <span class="n">RestaurantPredicate</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">completedTasks</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;restaurantPredicate_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">restaurant__hasFailed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">notCompletedPredicates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chosenPredicate</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">notCompletedPredicates</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-135'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-135'>#</a>
      </div>
      <p>mark chosenRestaurant as being in chosenBranch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">chosenPredicate</span><span class="o">.</span><span class="n">restaurant</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">chosenPredicate</span><span class="o">.</span><span class="n">index</span>

        <span class="k">return</span> <span class="n">chosenPredicate</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
